server {
    listen 80;
    server_name covfee.ewi.tudelft.nl www.covfee.ewi.tudelft.nl;

    # Redirect all connections to the https version of the site
    return 301 https://covfee.ewi.tudelft.nl$request_uri;
}

server{
    listen 443 ssl;   
    ssl_certificate /etc/ssl/covfee-ewi-tudelft-nl/covfee_ewi_tudelft_nl.pem;
    ssl_certificate_key /etc/ssl/covfee-ewi-tudelft-nl/covfee_ewi_tudelft_nl.key;

    # Show the flask app at www.covfee.ewi.tudelft.nl/covfee
    location /covfee {
        proxy_pass  http://localhost:5002/; # Redirect to the local port from gunicorn
        # proxy_pass http://unix:/home/edortaperez/covfee/samples/continuous_annotation/socket.io; # Redirect to the socket that was created by gunicorn
        rewrite ^/covfee(.*)$ /$1 break; # Remove the /covfee from the URL before passing it to the proxy_pass below
        include proxy_params; # Add the proxy configuration from the proxy_params file from the parent folder
    }

	# Redirects needed for flask-socket.io
	# https://flask-socketio.readthedocs.io/en/latest/deployment.html#using-nginx-as-a-websocket-reverse-proxy
    location /socket.io {
        include proxy_params;
        proxy_http_version 1.1;
        proxy_buffering off;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "Upgrade";
        proxy_pass http://localhost:5002/socket.io;
    }

    location /media {
      # autoindex on; # Enable to allow navigating over the files
      alias /home/edortaperez/covfee/samples/continuous_annotation/www;
    }
}
